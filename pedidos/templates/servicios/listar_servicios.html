<title>Listar Servicios</title>

{% extends 'layouts/navbar.html' %}

{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'vendors/feather/feather.css' %}" />
<link rel="stylesheet" href="{% static 'vendors/ti-icons/css/themify-icons.css' %}" />
<link rel="stylesheet" href="{% static 'vendors/css/vendor.bundle.base.css' %}" />
<!-- endinject -->
<!-- Plugin css for this page -->
<link rel="stylesheet" href="{% static 'vendors/datatables.net-bs4/dataTables.bootstrap4.css' %}" />
<link rel="stylesheet" href="{% static 'vendors/ti-icons/css/themify-icons.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'js/select.dataTables.min.css' %}" />
<!-- End plugin css for this page -->
<!-- inject:css -->
<link rel="stylesheet" href="{% static 'css/vertical-layout-light/style.css' %}" />
<link rel="stylesheet" href="{% static 'vendors/mdi/css/materialdesignicons.min.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.js"></script>


<div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Servicios</h4>
                <div class="table-responsive">
                    <table id="ServiciosTable" class="table table hover row-border" style="width:100%">
                        <thead>
                            <tr>
                                <th>Nombre del servicio</th>
                                <th>Tipo de servicio</th>
                                <th>Precio</th>
                                <th>Estado</th>
                                <th>Estado catálogo</th>
                                <th>Detalles</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for servicio in servicios %}
                            <tr class="pedido-row">
                                <td>{{ servicio.nombre_servicio }}</td>
                                <td>{{ servicio.id_TipoServicio }}</td>
                                <td>${{ servicio.precio_servicio|floatformat:"0" }}</td>
                                <td>
                                    {% if servicio.estado_servicio == 'A' %}
                                    <label class="badge btn-inverse-success hover-cursor {% if 'Editar Estado Servicio' in request.session.permisos %}change-status{% endif %}"
                                    data-servicio-id="{{ servicio.idServicio }}">Activo</label>
                                    {% else %}
                                    <label class="badge btn-inverse-danger hover-cursor {% if 'Editar Estado Servicio' in request.session.permisos %}change-status{% endif %}"
                                    data-servicio-id="{{ servicio.idServicio }}">Inactivo</label>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if servicio.estado_catalogo == 'A' %}
                                    <label class="badge btn-inverse-success hover-cursor {% if 'Editar Estado Servicio' in request.session.permisos %}change-status{% endif %}"
                                    data-usuario-id="{{ servicio.idServicio }}">Activo</label>
                                    {% else %}
                                    <label class="badge btn-inverse-danger hover-cursor {% if 'Editar Estado Servicio' in request.session.permisos %}change-status{% endif %}"
                                    data-usuario-id="{{ servicio.idServicio }}">Inactivo</label>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="badge btn-info hover-cursor" data-toggle="modal" data-target="#detalleServicioModal{{ servicio.idServicio }}">
                                        <i class="mdi mdi-eye"></i>
                                    </button>
                                </td>                                
                                <td>
                                    <div class="btn-group" role="group" aria-label="Basic example">
                                        <button type="button" class="btn btn-inverse-warning edit-servicio"
                                        data-toggle="modal" data-target="#editServicioModal{{ servicio.idServicio }}"
                                        data-servicio="{{ servicio.servicio.idServicio }}" 
                                        data-nombre="{{ servicio.nombre_servicio }}"
                                        data-Tservicio="{{ servicio.id_TipoServicio }}"
                                        data-precio="{{ servicio.precio_servicio }}"
                                        data-descripcion="{{ servicio.descripcion }}" 
                                        data-servicio-id="{{ servicio.idServicio }}">
                                        <i class="mdi mdi-pencil"></i>
                                        </button>
                                        
                                        <button type="button" class="btn btn-inverse-primary" data-servicio-id="{{ servicio.idServicio }}" data-toggle="modal" data-target="#editimgModal{{ servicio.idServicio }}">
                                            <i class="bi bi-file-earmark-image"></i>
                                        </button> 
                                        <button type="button" class="btn btn-inverse-danger delete-servicio" data-servicio-id="{{ servicio.idServicio }}">
                                            <i class="mdi mdi-delete"></i>
                                        </button> 
                                    </div>
                                </td>
                            </tr>

                            <!-- Modal Detalle del Servicio -->
                            <div class="modal fade" id="detalleServicioModal{{ servicio.idServicio }}" tabindex="-1" role="dialog" aria-labelledby="detalleServicioModal{{ servicio.idServicio }}Label" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="detalleServicioModal{{ servicio.idServicio }}Label">Detalle del Servicio</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <p><strong>Descripción:</strong> {{ servicio.descripcion }}</p>
                                            <p><strong>Imagen del servicio:</strong> <img src="{{ servicio.img.url }}" alt="Imagen " style="max-width: 100%; height: auto;"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                    
                            <!-- Modal para editar Servicio -->
                            <div class="modal fade" id="editServicioModal{{ servicio.idServicio }}" tabindex="-1" role="dialog"
                                aria-labelledby="editServicioModal{{ servicio.idServicio }}Label" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="editServicioModal{{ servicio.idServicio }}Label">Editar
                                                Servicio</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="post" onsubmit="EditarServicioxd('{{ servicio.idServicio }}')" id="Servicioform{{ servicio.idServicio }}" class="forms-sample" data-Pedido-id="{{ servicio.idServicio }}" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <input type="hidden" name="idServicio" value="{{ servicio.idServicio }}">
                                                <div class="form-row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="nombre_servicio">Nombre</label>
                                                            <input type="text" class="form-control" id="nombre_servicio" name="nombre_servicio"
                                                                 value="{{ servicio.nombre_servicio }}">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="precio">Precio</label>
                                                            <input type="number" class="form-control" name="precio_servicio" id="precio"
                                                                 value="{{ servicio.precio_servicio|floatformat:"0" }}">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="id_TipoServicio">Tipo de servicio</label>
                                                            <select name="id_TipoServicio" id="id_TipoServicio" class="form-control">
                                                                {% for tipo_servicio in tipo_servicios %}
                                                                <option value="{{ tipo_servicio.idTipo_Servicio }}" {% if tipo_servicio.idTipo_Servicio == servicio.id_TipoServicio.idTipo_Servicio %}selected{% endif %}>
                                                                    {{ tipo_servicio.nombre_tipoServicio }}
                                                                </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        

                                                    </div>
                                                    <div class="form-row">
                                                        <div class="col-md-12">
                                                            <label for="descripcion">Descripción</label>
                                                            <textarea name="descripcion" class="form-control" id="descripcion" cols="1000" rows="5" value="{{ servicio.descripcion }}">{{ servicio.descripcion }}</textarea><br>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Botones -->
                                                <div class="form-row">
                                                    <div class="col-md-12">
                                                        <button class="btn btn-primary mr-2">Editar {{ servicio.idServicio }}</button>
                                                        <button type="button" class="btn btn-light"
                                                            data-dismiss="modal">Cancelar</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal fade" id="editimgModal{{ servicio.idServicio }}" tabindex="-1" role="dialog"
                                aria-labelledby="editServicioModal{{ servicio.idServicio }}Label" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="editServicioModal{{ servicio.idServicio }}Label">Editar Evidecia
                                                Pedido</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="post" onsubmit="EditarImgServicioxd('{{ servicio.idServicio }}')" id="EditarImgForm{{ servicio.idServicio }}" class="forms-sample" data-Pedido-id="{{ servicio.idServicio }}" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <input type="hidden" name="idServicio" value="{{ servicio.idServicio }}">
                                                <div class="form-row">
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <p><strong>Imagen actual:</strong> <img src="{{ servicio.img.url }}" alt="Imagen " style="max-width: 100%; height: auto;"></p>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <input type="file" name="img" class="form-control-file img_input" accept="image/*" data-vista-previa="imagen_vista_previa_{{ servicio.idServicio }}">
                                                            <br>
                                                            <img src="#" id="imagen_vista_previa_{{ servicio.idServicio }}" alt="Vista previa de la imagen" style="display: none; max-width: 100%; height: auto;">
                                                        </div>

                                                    </div>
                                                </div>

                                                <!-- Botones -->
                                                <div class="form-row">
                                                    <div class="col-md-12">
                                                        <button class="btn btn-primary mr-2">Editar {{ servicio.idServicio }}</button>
                                                        <button type="button" class="btn btn-light"
                                                            data-dismiss="modal">Cancelar</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Destruir la instancia actual, si existe
        if ($.fn.DataTable.isDataTable('#ServiciosTable')) {
            $('#ServiciosTable').DataTable().destroy();
        }

        // Configuración personalizada para DataTables
        var dataTableConfig = {
            // "pagingType": "full_numbers",
            "lengthChange": false,
            "pageLength": 5,
            "searching": true,
            "language": {
                "search": "Buscar:",
                "zeroRecords": "No se encontraron resultados",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                "infoEmpty": "Mostrando 0 a 0 de 0 registros",
                "infoFiltered": "(filtrados de _MAX_ registros en total)",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            },
            "dom": '<"top"lf>rt<"bottom"ip>',
        };

        // Inicializar DataTable con la configuración personalizada
        var table = $('#ServiciosTable').DataTable(dataTableConfig);

        // Mover el cuadro de búsqueda al lugar deseado
        $("#ServiciosTable_filter").detach().appendTo(".top");

        // Mover el botón "Agregar" al lado del cuadro de búsqueda
        {% if "Crear Tipo Servicios" in request.session.permisos %}
        $(".top").append('<button type="button" class="btn btn-inverse-success btn-fw ml-2" data-toggle="modal" data-target="#myModal"  style="margin: 5px">Agregar</button>');
        {% endif %}
        // También puedes personalizar el estilo del cuadro de búsqueda si es necesario
        $("#ServiciosTable_filter input").addClass("form-control form-control-sm");

        // Puedes agregar más personalizaciones según tus necesidades



    });

    // Agregar evento clic para el botón edit-servicio
    $('.edit-servicio').on('click', function () {
        // Obtener la información del pedido
        var servicioInfo = {
            Servicio: "Datos del servicio",
            Tipo_servicio: "Datos del tipo de servicio",
            Nombre_servicio: "Datos del nombre del servicio",
            descripcion: "descripcion servicio",
            precio_servicio: "precio servicio",
            img: "imagen del servicio",

        };

        // Llenar la modal con la información del pedido
        $('#editServicioModal #Servicio').val(servicioInfo.Servicio);
        $('#editServicioModal #id_TipoServicio').val(servicioInfo.Tipo_servicio);
        $('#editServicioModal #nombre_servicio').val(servicioInfo.Nombre_servicio);
        $('#editServicioModal #precio_servicio').val(servicioInfo.precio_servicio);
        $('#editServicioModal #img').val(servicioInfo.img);


        // Mostrar la modal
        $('#editServicioModal').modal('show');
    });

    function EditarServicioxd(servicioxd) {
        event.preventDefault();

        // Obtener el formulario
        const form = document.getElementById(`Servicioform${servicioxd}`);
        // Crear un objeto FormData para enviar los datos del formulario
        const formData = new FormData(form);

        const formDataString = JSON.stringify(Object.fromEntries(formData));
        const formString = form.outerHTML;

        // Realizar la solicitud POST utilizando fetch
        fetch("{% url 'pedidos:editar_servicio' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                // Verificar si la solicitud fue exitosa
                if (data.success) {
                    // Mostrar SweetAlert de éxito
                    Swal.fire({
                        title: '¡Actualización exitosa!',
                        text: 'El servicio se ha editado correctamente.',
                        icon: 'success',
                        onClose: () => {
                            // Recargar la página   
                            location.reload();
                        }
                    }).then(() => {
                        location.reload();
                    });
                } else if (data.errors) { // Verificar si hay errores de validación
                    let errorMessage = "Hubo un error al procesar su solicitud:<br>";
                    for (const key in data.errors) {
                        errorMessage += `${data.errors[key]}<br>`;
                    }
                    Swal.fire({
                        title: 'Error',
                        html: errorMessage,
                        icon: 'error',
                    });
                } else { // Si no hay errores específicos de validación, mostrar un mensaje genérico de error
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un error al procesar su solicitud. Por favor, revise los campos e inténtelo de nuevo.',
                        icon: 'error'
                    });
                }
            })
            .catch(errors => {
                // Mostrar SweetAlert de error en caso de un fallo en la solicitud
                Swal.fire({
                    title: 'Error',
                    text: 'Hubo un error al procesar su solicitud. Por favor, inténtelo de nuevo más tarde.',
                    icon: 'error'
                });
                console.error('Error:', errors);
            });
    }

    function EditarImgServicioxd(servicioId) {
        event.preventDefault();

        // Obtener el formulario
        const form = document.getElementById(`EditarImgForm${servicioId}`);
        // Crear un objeto FormData para enviar los datos del formulario
        const formData = new FormData(form);

        const formDataString = JSON.stringify(Object.fromEntries(formData));
        const formString = form.outerHTML;

        // Realizar la solicitud POST utilizando fetch
        fetch("{% url 'pedidos:editar_img_servicio' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                // Verificar si la solicitud fue exitosa
                if (data.success) {
                    // Mostrar SweetAlert de éxito
                    Swal.fire({
                        title: '¡Actualización exitosa!',
                        text: 'El la imagen del servicio se ha editado correctamente.',
                        icon: 'success',
                        onClose: () => {
                            // Recargar la página   
                            location.reload();
                        }
                    }).then(() => {
                        location.reload();
                    });
                } else if (data.errors) { // Verificar si hay errores de validación
                    let errorMessage = "Hubo un error al procesar su solicitud:<br>";
                    for (const key in data.errors) {
                        errorMessage += `${data.errors[key]}<br>`;
                    }
                    Swal.fire({
                        title: 'Error',
                        html: errorMessage,
                        icon: 'error',
                    });
                } else { // Si no hay errores específicos de validación, mostrar un mensaje genérico de error
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un error al procesar su solicitud. Por favor, revise los campos e inténtelo de nuevo.',
                        icon: 'error'
                    });
                }
            })
            .catch(errors => {
                // Mostrar SweetAlert de error en caso de un fallo en la solicitud
                Swal.fire({
                    title: 'Error',
                    text: 'Hubo un error al procesar su solicitud. Por favor, inténtelo de nuevo más tarde.',
                    icon: 'error'
                });
                console.error('Error:', errors);
            });
    }
        // Función para mostrar la vista previa de la imagen al seleccionar un archivo
    function mostrarVistaPrevia(input, elementoVistaPrevia) {
        var archivo = input.files[0];
        var imagenVistaPrevia = document.getElementById(elementoVistaPrevia);

        // Verificar si se seleccionó un archivo
        if (archivo) {
            // Crear un objeto URL para el archivo seleccionado
            var objetoURL = URL.createObjectURL(archivo);

            // Mostrar la vista previa de la imagen
            imagenVistaPrevia.style.display = 'block';
            imagenVistaPrevia.src = objetoURL;
        } else {
            // Ocultar la vista previa si no se seleccionó ningún archivo
            imagenVistaPrevia.style.display = 'none';
        }
    }

    // Agregar un evento change a cada input de tipo file para mostrar la vista previa
    var inputsEvidenciaPago = document.querySelectorAll('.img_input');
    inputsEvidenciaPago.forEach(function(input) {
        input.addEventListener('change', function(event) {
            var elementoVistaPrevia = this.dataset.vistaPrevia;
            mostrarVistaPrevia(this, elementoVistaPrevia);
        });
    });


        // Función para mostrar la vista previa de la imagen al seleccionar un archivo
        function mostrarVistaPrevia(input, elementoVistaPrevia) {
            var archivo = input.files[0];
            var imagenVistaPrevia = document.getElementById(elementoVistaPrevia);
    
            // Verificar si se seleccionó un archivo
            if (archivo) {
                // Crear un objeto URL para el archivo seleccionado
                var objetoURL = URL.createObjectURL(archivo);
    
                // Mostrar la vista previa de la imagen
                imagenVistaPrevia.style.display = 'block';
                imagenVistaPrevia.src = objetoURL;
            } else {
                // Ocultar la vista previa si no se seleccionó ningún archivo
                imagenVistaPrevia.style.display = 'none';
            }
        }
    
        // Agregar un evento change a cada input de tipo file para mostrar la vista previa
        var inputsEvidenciaPago = document.querySelectorAll('.img_input');
        inputsEvidenciaPago.forEach(function(input) {
            input.addEventListener('change', function(event) {
                var elementoVistaPrevia = this.dataset.vistaPrevia;
                mostrarVistaPrevia(this, elementoVistaPrevia);
            });
        });

    

</script>



{% if not request.session.usuario_id %}
<script>
    window.location.href = "{% url 'usuarios:requestLogin' %}";

</script>
{% elif "Listar Tipo Servicios" not in request.session.permisos %}
<script>
    window.location.href = "{% url 'usuarios:requestLogin' %}";

</script>
{% endif %}
{% endblock %}