<title>Listar Pedidos</title>
{% extends 'layouts/navbar.html' %}
{% load humanize %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'vendors/feather/feather.css' %}" />
<link rel="stylesheet" href="{% static 'vendors/ti-icons/css/themify-icons.css' %}" />
<link rel="stylesheet" href="{% static 'vendors/css/vendor.bundle.base.css' %}" />
<!-- endinject -->
<!-- Plugin css for this page -->
<link rel="stylesheet" href="{% static 'vendors/datatables.net-bs4/dataTables.bootstrap4.css' %}" />
<link rel="stylesheet" href="{% static 'vendors/ti-icons/css/themify-icons.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'js/select.dataTables.min.css' %}" />
<!-- End plugin css for this page -->
<!-- inject:css -->
<link rel="stylesheet" href="{% static 'css/vertical-layout-light/style.css' %}" />
<link rel="stylesheet" href="{% static 'vendors/mdi/css/materialdesignicons.min.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.js"></script>

<!-- endinject -->
<script src="{% static 'js/pedidos.js' %}"></script>


<!-- Contenido principal -->
<div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Productos</h4>
                <div class="table-responsive">
                    <table id="pedidoTable" class="table table-hover row-border" style="width:100%">
                        <thead>
                            <tr>
                                <th>Tipo Producto</th>
                                <th>Nombre</th>
                                <th>Descripcion</th>
                                <th>Precio</th>
                                <th>Estado producto</th>
                                <th>Estado catalogo</th>
                                <th>Cantidad</th>
                                <th>Acciones</th>

                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos %}
                            <tr class="producto-row">
                                <td>{{ producto.id_TipoProducto }}</td>
                                <td>{{ producto.nombre }}</td>
                                <td>
                                    <button type="button" class="badge btn-info hover-cursor" data-toggle="modal" data-target="#detalleProductoModal{{ producto.idProducto }}">
                                        <i class="mdi mdi-eye"></i>
                                    </button>
                                </td>
                                <td>$ {{ producto.precio|floatformat:"0"|intcomma }}</td>                                

                                <td>
                                    {% if producto.estado_producto == 'A' %}
                                    <label class="badge btn-inverse-success hover-cursor {% if "Editar Estado Productos"  in request.session.permisos %}change-status{% endif %}"
                                    data-producto-id="{{ producto.idProducto }}">Activo</label>
                                    {% else %}
                                    <label class="badge btn-inverse-danger hover-cursor {% if "Editar Estado Productos"  in request.session.permisos %}change-status{% endif %}"
                                    data-producto-id="{{ producto.idProducto }}">Inactivo</label>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if producto.estado_catalogo == 'A' %}
                                    <label class="badge btn-inverse-success hover-cursor {% if "Editar Estado Catalogo Productos"  in request.session.permisos %}change-status-catalogo{% endif %}"
                                    data-producto-id="{{ producto.idProducto }}">Activo</label>
                                    {% else %}
                                    <label class="badge btn-inverse-danger hover-cursor {% if "Editar Estado Catalogo Productos"  in request.session.permisos %}change-status-catalogo{% endif %}"
                                    data-producto-id="{{ producto.idProducto }}">Inactivo</label>
                                    {% endif %}
                                </td>                                
                                <td><center>{{ producto.cantidad }}</center></td>                                
                                <td>
                                    <div class="btn-group" role="group" aria-label="Basic example">
                                        {% if 'Editar Productos' in request.session.permisos %}
                                        <button type="button" class="btn btn-inverse-warning edit-producto"
                                        data-toggle="modal" data-target="#editarproductoModal{{ producto.idProducto }}"
                                        data-nombre="{{ producto.nombre }}"
                                        data-descripcion="{{ producto.descripcion }}"
                                        data-precio="{{ producto.precio }}" 
                                        data-estado-producto="{{ producto.estado_producto }} " data-producto-id="{{ producto.idProducto }}" 
                                        data-estado-catalogo=" {{ producto.estado_catalogo }} " data-catalogo-id="{{ producto.idProducto }}"
                                        data-cantidad=" {{ producto.cantidad }} ">
                                        <i class="mdi mdi-pencil"></i>
                                        </button>
                                        {% endif %}
                                        {% if 'Cambiar Imagen Productos' in request.session.permisos %}
                                        <button type="button" class="btn btn-inverse-primary" data-producto-id="{{ producto.idProducto }}" data-toggle="modal" data-target="#editevidenciaproductoModal{{ producto.idProducto }}">
                                            <i class="bi bi-file-earmark-image"></i>
                                        </button>
                                        {% endif %}
                                        {% if 'Eliminar Productos' in request.session.permisos %}
                                        <button type="button" class="btn btn-inverse-danger delete-producto" data-producto-id="{{ producto.idProducto }}">
                                            <i class="mdi mdi-delete"></i>
                                        </button> 
                                        {% endif %}
                                        {% if 'Eliminar Productos' not in request.session.permisos and 'Editar Productos' not in request.session.permisos %}
                                            <button type="button" class="btn btn-inverse-primary">
                                                <i class="bi bi-exclamation-circle"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>                              
                            </tr>
                            
                    
                                <!-- Modal para editar Pedido -->
                                <div class="modal fade" id="editarProductoModal{{ producto.idProducto }}" tabindex="-1" role="dialog"
                                aria-labelledby="editarProductoModal{{ producto.idProducto }}Label" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="editarproductoModal{{ producto.idProducto }}Label">Editar Producto</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="post" onsubmit="EditarProductoxd('{{ producto.idProducto }}')" id="editarProductoform{{ producto.idProducto }}" class="forms-sample" data-Producto-id="{{ producto.idProducto }}" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <input type="hidden" name="producto_id" value="{{ producto.idProducto }}">
                                                <div class="form-row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="nombre">Nombre</label>
                                                            <input type="text" class="form-control" id="nombre" name="nombre" value="{{ producto.nombre }}">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="estado_producto">Estado del Producto</label>
                                                            <select class="form-control" id="estado_producto" name="estado_producto">
                                                                <option value="A" {% if producto.estado_producto == 'A' %} selected {% endif %}>Activo</option>
                                                                <option value="I" {% if producto.estado_producto == 'I' %} selected {% endif %}>Inactivo</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="descripcion">Descripción</label>
                                                            <textarea class="form-control" id="descripcion" name="descripcion">{{ producto.descripcion }}</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="estado_catalogo">Estado del Catálogo</label>
                                                            <select class="form-control" id="estado_catalogo" name="estado_catalogo">
                                                                <option value="A" {% if producto.estado_catalogo == 'A' %} selected {% endif %}>Activo</option>
                                                                <option value="I" {% if producto.estado_catalogo == 'I' %} selected {% endif %}>Inactivo</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="precio">Precio</label>
                                                            <input type="number" class="form-control" id="precio" name="precio" value="{{ producto.precio|floatformat:"0" }}">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="cantidad">Cantidad</label>
                                                            <input type="number" class="form-control" id="cantidad" name="cantidad" value="{{ producto.cantidad }}">
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Botones -->
                                                <div class="form-row">
                                                    <div class="col-md-12">
                                                        <button class="btn btn-primary mr-2" type="submit">Editar</button>
                                                        <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                </div>

                              <!-- Modal Detalle del Servicio -->
                            <div class="modal fade" id="detalleProductoModal{{ producto.idProducto }}" tabindex="-1" role="dialog" aria-labelledby="detalleProductoModal{{ producto.idProducto }}Label" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="detalleProductoModal{{ producto.idProducto }}Label">Descripcion del producto</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <p><strong>Descripción:</strong> {{ producto.descripcion }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>             

                            <!-- Modal para editar imagen de Producto -->
                            <div class="modal fade" id="editevidenciaproductoModal{{ producto.idProducto }}" tabindex="-1" role="dialog"
                            aria-labelledby="editarproductoModal{{ producto.idProducto }}Label" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editarproductoModal{{ producto.idProducto }}Label">Editar imagen de
                                            Producto</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form method="post" onsubmit="EditarEvidenciaProductoxd('{{ producto.idProducto }}')" id="EditarEvidenciaForm{{ producto.idProducto }}" class="forms-sample" data-producto-id="{{ producto.idProducto }}" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <input type="hidden" name="producto_id" value="{{ producto.idProducto }}">

                                            <div class="form-row">
                                                <div class="col-md-12">
                                                    <div class="form-group">
                                                        {% if producto.imagen %}
                                                        <p><strong>Imagen actual:</strong> <img src="{{ producto.imagen.url }}" alt="imagen" style="max-width: 100%; height: auto;"></p>
                                                        {% else %}
                                                        <p><strong>Imagen actual:</strong> <img src="/media/user_images/imagendefectoNoBorrar.gif" alt="imagen" style="max-width: 100%; height: auto;"></p>                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-12">
                                                    <div class="form-group">
                                                        <input type="file" name="imagen" class="form-control-file evidencia_pago_input" accept="image/*" data-vista-previa="imagen_vista_previa_{{ producto.idProducto }}">
                                                        <br>
                                                        <img src="#" id="imagen_vista_previa_{{ producto.idProducto }}" alt="Vista previa de la imagen" style="display: none; max-width: 100%; height: auto;">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Botones -->
                                            <div class="form-row">
                                                <div class="col-md-12">
                                                    <button type="submit" class="btn btn-primary mr-2">Editar</button>
                                                    <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Fin del contenido principal -->



<!-- Modal Crear Producto -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Registro de Productos</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Contenido del formulario con Bootstrap grid system -->
                <form method="post" onsubmit="validateProductoForm('{{ producto.idProducto }}')" id="productoForm{{ pedido.idPedido }}" class="forms-sample" data-producto-id="{{ producto.idProducto }}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Primera fila con dos columnas -->
                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_TipoProducto">Tipo de Producto</label>
                                {{ formCreate.id_TipoProducto }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="nombre">Nombre</label>
                                {{ formCreate.nombre }}
                            </div>
                        </div>
                    </div>
                    <!-- Segunda fila con dos columnas -->
                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="precio">Precio</label>
                                {{ formCreate.precio }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="imagen">Imagen</label>
                                <input type="file" name="imagen" class="form-control-file evidencia_pago_input" accept="image/*" data-vista-previa="imagen_vista_previa_{{ producto.idProducto }}">
                                <br>
                                <img src="#" id="imagen_vista_previa_{{ producto.idProducto }}" alt="Vista previa de la imagen" style="display: none; max-width: 100%; height: auto;">
                            </div>
                        </div>
                    </div>
                    <!-- Tercera fila con dos columnas -->
                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="estado_producto">Estado del Producto</label>
                                <select class="form-control" id="estado_producto" name="estado_producto">
                                    <option value="A" {% if producto.estado_producto == 'A' %} selected {% endif %}>Activo</option>
                                    <option value="I" {% if producto.estado_producto == 'I' %} selected {% endif %}>Inactivo</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="estado_catalogo">Estado del Catálogo</label>
                                <select class="form-control" id="estado_catalogo" name="estado_catalogo">
                                    <option value="A" {% if producto.estado_catalogo == 'A' %} selected {% endif %}>Activo</option>
                                    <option value="I" {% if producto.estado_catalogo == 'I' %} selected {% endif %}>Inactivo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Cuarta fila con una columna -->
                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cantidad">Cantidad</label>
                                {{ formCreate.cantidad }}
                            </div>
                        </div>
                    </div>
                    <!-- Quinta fila con una columna -->
                    <div class="form-row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="descripcion">Descripción del Producto</label>
                                {{ formCreate.descripcion }}
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="form-row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary mr-2">Registrar</button>
                            <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- Fin del Modal Crear Pedido -->



<script>
    // Función para validar el formulario de creación de pedido
    function validateProductoForm(productoId) {
        // Evitar que el formulario se envíe automáticamente
        event.preventDefault();

        // Obtener el formulario correspondiente al pedido
        const form = document.getElementById(`productoForm${productoId}`);

        // Crear un objeto FormData para enviar los datos del formulario
        const formData = new FormData(form);

        // Realizar la solicitud POST utilizando fetch
        fetch("{% url 'pedidos:crear_producto' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                // Verificar si la solicitud fue exitosa
                if (data.success) {
                    // Mostrar SweetAlert de éxito
                    Swal.fire({
                        title: '¡Registro exitoso!',
                        text: 'El producto se ha registrado correctamente.',
                        icon: 'success',
                        onClose: () => {
                            // Recargar la página
                            location.reload();
                        }
                    }).then(() => {
                        location.reload();
                    });
                } else if (data.message) { // Check if a message is provided in the response
                    Swal.fire({
                        title: 'Error',
                        text: data.message,
                        icon: 'error',
                    });
                } else if (data.errors) { // Verificar si hay errores de validación
                    let errorMessage = "Hubo un error al procesar su solicitud:<br>";
                    for (const key in data.errors) {
                        errorMessage += `${data.errors[key]}<br>`;
                    }
                    Swal.fire({
                        title: 'Error',
                        html: errorMessage,
                        icon: 'error',
                    });
                } else { // If no message is provided, show a generic error message
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un error al procesar su solicitud. Por favor, revise los campos e inténtelo de nuevo.',
                        icon: 'error'
                    });
                }
            })
            .catch(errors => {
                // Mostrar SweetAlert de error en caso de un fallo en la solicitud
                Swal.fire({
                    title: 'Error',
                    text: 'Hubo un error al procesar su solicitud. Por favor, inténtelo de nuevo más tarde.',
                    icon: 'error'
                });
                console.error('Error:', errors);
            });
    }

    // Agregar evento clic para el botón edit-pedido
    $('.edit-producto').on('click', function () {
        // Obtener la información del pedido
        var productoInfo = {
            id_TipoProducto: "Datos del tipo de producto",
            nombre: "Nombre del producto",
            descripcion: "Descripcion del producto",
            precio: "Precio del producto",
            estado_producto: "Estado del producto",
            estado_catalogo: "Estado del catalogo",
            cantidad: "Cantidad del producto",
        };

        // Llenar la modal con la información del pedido
        $('#editarproductoModal #id_TipoProducto').val(productoInfo.id_TipoProducto);
        $('#editarproductoModal #nombre').val(productoInfo.nombre);
        $('#editarproductoModal #descripcion').val(productoInfo.descripcion);
        $('#editarproductoModal #precio').val(productoInfo.precio);
        $('#editarproductoModal #estado_producto').val(productoInfo.estado_producto);
        $('#editarproductoModal #estado_catalogo').val(productoInfo.estado_catalogo);
        $('#editarproductoModal #cantidad').val(productoInfo.cantidad);

        // Mostrar la modal
        $('#editarproductoModal').modal('show');
    });

    $(document).ready(function() {
        // Adjuntar evento de clic a los elementos con clase change-status
        $('.change-status').click(handleChangeStatus);
        $('.change-status-catalogo').click(handleChangeStatus2);
    });
    
    // Función para manejar el cambio de estado del producto
    $(document).ready(function() {
        $('.change-status-button').click(handleChangeStatus);
    });
    
    function handleChangeStatus(event) {
        var producto_id = $(this).data('producto-id');
        var estado_actual = $(this).text().trim();
        var nuevo_estado = estado_actual === 'Activo' ? 'Inactivo' : 'Activo';
    
        Swal.fire({
            title: '¿Estás seguro?',
            text: `Estás a punto de cambiar el estado del producto a "${nuevo_estado}".`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, cambiar estado',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                cambiarEstadoProducto(producto_id, nuevo_estado);
            }
        });
    }
    
    function cambiarEstadoProducto(producto_id, nuevo_estado) {
        fetch("{% url 'pedidos:cambiar_estado_productos' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'producto_id': producto_id,
                    'estado_producto': nuevo_estado,
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Hubo un problema al cambiar el estado.');
                }
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    title: '¡Estado cambiado!',
                    text: `El estado del producto se ha cambiado a "${nuevo_estado}" correctamente.`,
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1500,
                }).then(() => {
                    location.reload()
                });

            })
            .catch(error => {
                Swal.fire({
                    title: 'Error',
                    text: 'Hubo un problema al cambiar el estado del producto.',
                    icon: 'error'
                });
            });
    }
    
// Función para manejar el cambio de estado del catálogo
function handleChangeStatus2(event) {
    var producto_id = $(this).data('producto-id'); // Corrige esto

    Swal.fire({
        title: '¿Estás seguro?',
        text: `Estás a punto de cambiar el estado del catálogo.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, cambiar estado',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            cambiarEstadoCatalogo(producto_id);
        }
    });
}
// Función para manejar el cambio de estado del catálogo
function handleChangeStatus2(event) {
    var producto_id = $(this).data('producto-id');
    var estado_actual = $(this).text().trim();
    var nuevo_estado = estado_actual === 'Activo' ? 'Inactivo' : 'Activo';

    Swal.fire({
        title: '¿Estás seguro?',
        text: `Estás a punto de cambiar el estado del catálogo a "${nuevo_estado}".`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, cambiar estado',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            cambiarEstadoCatalogo(producto_id, nuevo_estado);
        }
    });
}

function cambiarEstadoCatalogo(producto_id, nuevo_estado) {
    fetch("{% url 'pedidos:cambiar_estado_catalogo' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            'producto_id': producto_id,
            'estado_catalogo': nuevo_estado,
        }),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Hubo un problema al cambiar el estado.');
        }
        return response.json();
    })
    .then(data => {
        Swal.fire({
            title: '¡Estado cambiado!',
            text: `El estado del catálogo se ha cambiado a "${nuevo_estado}" correctamente.`,
            icon: 'success',
            showConfirmButton: false,
            timer: 1500,
        }).then(() => {
            location.reload();
        });
    })
    .catch(error => {
        Swal.fire({
            title: 'Error',
            text: 'Hubo un problema al cambiar el estado del catálogo.',
            icon: 'error'
        });
    });
}


    $(document).ready(function () {
        // Destruir la instancia actual, si existe
        if ($.fn.DataTable.isDataTable('#pedidoTable')) {
            $('#pedidoTable').DataTable().destroy();
        }

        // Configuración personalizada para DataTables
        var dataTableConfig = {
            "lengthChange": false,
            "pageLength": 5,
            "searching": true,
            "language": {
                "search": "Buscar:",
                "zeroRecords": "No se encontraron resultados",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                "infoEmpty": "Mostrando 0 a 0 de 0 registros",
                "infoFiltered": "(filtrados de _MAX_ registros en total)",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            },
            "dom": '<"top"lf>rt<"bottom"ip>',
        };

        // Inicializar DataTable con la configuración personalizada
        var table = $('#pedidoTable').DataTable(dataTableConfig);

        // Mover el cuadro de búsqueda al lugar deseado
        $("#pedidoTable_filter").detach().appendTo(".top");
        {% if "Crear Productos"  in request.session.permisos %}
        // Agregar el botón "Agregar" al lado del cuadro de búsqueda
        $(".top").append('<button type="button" class="btn btn-inverse-success btn-fw ml-2" data-toggle="modal" data-target="#myModal" style="margin: 5px">Agregar</button>');
        {% endif %}
        // También puedes personalizar el estilo del cuadro de búsqueda si es necesario
        $("#pedidoTable_filter input").addClass("form-control form-control-sm");

        // Manejar el evento de cambio de estado del pedido
        $('#pedidoTable').on('click', 'td .change-status', handleChangeStatus);
    });

    function EditarProductoxd(productoId) {
    event.preventDefault();

    // Obtener el formulario usando el ID del producto
    const form = document.getElementById(`editarProductoform${productoId}`);

    // Crear un objeto FormData para enviar los datos del formulario
    const formData = new FormData(form);

    // Realizar la solicitud POST utilizando fetch
    fetch("{% url 'pedidos:editar_producto' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Verificar si la solicitud fue exitosa
        if (data.success) {
            // Mostrar SweetAlert de éxito
            Swal.fire({
                title: '¡Actualización exitosa!',
                text: 'El producto se ha editado correctamente.',
                icon: 'success',
                onClose: () => {
                    // Recargar la página   
                    location.reload();
                }
            }).then(() => {
                location.reload();
            });
        } else if (data.errors) { // Verificar si hay errores de validación
            let errorMessage = "Hubo un error al procesar su solicitud:<br>";
            for (const key in data.errors) {
                errorMessage += `${data.errors[key]}<br>`;
            }
            Swal.fire({
                title: 'Error',
                html: errorMessage,
                icon: 'error',
            });
        } else { // Si no hay errores específicos de validación, mostrar un mensaje genérico de error
            Swal.fire({
                title: 'Error',
                text: 'Hubo un error al procesar su solicitud. Por favor, revise los campos e inténtelo de nuevo.',
                icon: 'error'
            });
        }
    })
    .catch(errors => {
        // Mostrar SweetAlert de error en caso de un fallo en la solicitud
        Swal.fire({
            title: 'Error',
            text: 'Hubo un error al procesar su solicitud. Por favor, inténtelo de nuevo más tarde.',
            icon: 'error'
        });
        console.error('Error:', errors);
    });
}



function EditarEvidenciaProductoxd(productoId) {
    event.preventDefault();

    // Obtener el formulario
    const form = document.getElementById(`EditarEvidenciaForm${productoId}`);
    // Crear un objeto FormData para enviar los datos del formulario
    const formData = new FormData(form);

    // Realizar la solicitud POST utilizando fetch
    fetch("{% url 'pedidos:editar_evidencia_productos' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
        .then(response => response.json())
        .then(data => {
            // Verificar si la solicitud fue exitosa
            if (data.success) {
                // Mostrar SweetAlert de éxito
                Swal.fire({
                    title: '¡Actualización exitosa!',
                    text: 'El producto se ha editado correctamente.',
                    icon: 'success',
                    onClose: () => {
                        // Recargar la página
                        location.reload();
                    }
                }).then(() => {
                    location.reload();
                });
            } else if (data.errors) { // Verificar si hay errores de validación
                let errorMessage = "Hubo un error al procesar su solicitud:<br>";
                for (const key in data.errors) {
                    errorMessage += `${data.errors[key]}<br>`;
                }
                Swal.fire({
                    title: 'Error',
                    html: errorMessage,
                    icon: 'error',
                });
            } else { // Si no hay errores específicos de validación, mostrar un mensaje genérico de error
                Swal.fire({
                    title: 'Error',
                    text: 'Hubo un error al procesar su solicitud. Por favor, revise los campos e inténtelo de nuevo.',
                    icon: 'error'
                });
            }
        })
        .catch(errors => {
            // Mostrar SweetAlert de error en caso de un fallo en la solicitud
            Swal.fire({
                title: 'Error',
                text: 'Hubo un error al procesar su solicitud. Por favor, inténtelo de nuevo más tarde.',
                icon: 'error'
            });
            console.error('Error:', errors);
        });
}


    function eliminarProducto(producto_id) {
    // Realizar la solicitud POST utilizando fetch
    fetch("{% url 'pedidos:eliminar_producto' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({'producto_id': producto_id})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Producto Eliminado!', 'Producto Eliminado correctamente.', 'success').then(() => {
                location.reload();
            });
        } else {
            // Mostrar un mensaje de error si la eliminación falla
            Swal.fire({
                title: 'Error',
                text: data.message,
                icon: 'error'
            });
        }
    })
    .catch(error => {
        // Mostrar un mensaje de error en caso de un fallo en la solicitud
        console.error('Error:', error);
        Swal.fire({
            title: 'Error',
            text: 'Hubo un error al intentar eliminar el producto. Por favor, inténtelo de nuevo más tarde.',
            icon: 'error'
        });
    });
}

document.querySelectorAll('.delete-producto').forEach(button => {
    button.addEventListener('click', function() {
        const productoId = $(this).data('producto-id');
        // Confirmar antes de eliminar, mostrando el ID del producto en la alerta
        Swal.fire({
            title: '¿Estás seguro?',
            text: `Esta acción no se puede deshacer para el producto con ID ${productoId}. ¿Deseas continuar?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                eliminarProducto(productoId);
            }
        });
    });
});


</script>

<script>
    // Función para mostrar la vista previa de la imagen al seleccionar un archivo
    function mostrarVistaPrevia(input, elementoVistaPrevia) {
        var archivo = input.files[0];
        var imagenVistaPrevia = document.getElementById(elementoVistaPrevia);

        // Verificar si se seleccionó un archivo
        if (archivo) {
            // Crear un objeto URL para el archivo seleccionado
            var objetoURL = URL.createObjectURL(archivo);

            // Mostrar la vista previa de la imagen
            imagenVistaPrevia.style.display = 'block';
            imagenVistaPrevia.src = objetoURL;
        } else {
            // Ocultar la vista previa si no se seleccionó ningún archivo
            imagenVistaPrevia.style.display = 'none';
        }
    }

    // Agregar un evento change a cada input de tipo file para mostrar la vista previa
    var inputsEvidenciaPago = document.querySelectorAll('.evidencia_pago_input');
    inputsEvidenciaPago.forEach(function(input) {
        input.addEventListener('change', function(event) {
            var elementoVistaPrevia = this.dataset.vistaPrevia;
            mostrarVistaPrevia(this, elementoVistaPrevia);
        });
    });
</script>



{% if not request.session.usuario_id %}
<script>
    window.location.href = "{% url 'usuarios:requestLogin' %}";
</script>
{% elif "Listar Productos" not in request.session.permisos %}
<script>
    window.location.href = "{% url 'usuarios:requestLogin' %}";
</script>
{% endif %}

{% endblock %}
