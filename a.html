<script>
  let itemsArray = [];

  $(document).ready(function() {
      $('.select2').select2({
          placeholder: 'Selecciona opciones',
          theme: 'classic',
          width: '50%',
          closeOnSelect: false,
      });

      // Handle adding products
      $('#productos + .btn').click(function() {
          const selectedProduct = $('#productos').val();
          const selectedProductText = $('#productos option:selected').text();
          if (selectedProduct) {
              Swal.fire({
                  title: 'Cantidad de Producto',
                  input: 'number',
                  inputAttributes: {
                      min: 1,
                      step: 1
                  },
                  showCancelButton: true,
                  confirmButtonText: 'Agregar',
                  cancelButtonText: 'Cancelar'
              }).then((result) => {
                  if (result.isConfirmed) {
                      const quantity = result.value;
                      itemsArray.push({
                          id: selectedProduct,
                          name: selectedProductText,
                          quantity: quantity,
                          type: 'product'
                      });
                      Swal.fire('Agregado!', 'El producto ha sido agregado.', 'success');
                  }
              });
          } else {
              Swal.fire('Error', 'Seleccione un producto', 'error');
          }
      });

      // Handle adding services
      $('#servicios + .btn').click(function() {
          const selectedService = $('#servicios').val();
          const selectedServiceText = $('#servicios option:selected').text();
          if (selectedService) {
              Swal.fire({
                  title: 'Cantidad de Servicio',
                  input: 'number',
                  inputAttributes: {
                      min: 1,
                      step: 1
                  },
                  showCancelButton: true,
                  confirmButtonText: 'Agregar',
                  cancelButtonText: 'Cancelar'
              }).then((result) => {
                  if (result.isConfirmed) {
                      const quantity = result.value;
                      itemsArray.push({
                          id: selectedService,
                          name: selectedServiceText,
                          quantity: quantity,
                          type: 'service'
                      });
                      Swal.fire('Agregado!', 'El servicio ha sido agregado.', 'success');
                  }
              });
          } else {
              Swal.fire('Error', 'Seleccione un servicio', 'error');
          }
      });

      // Handle form submission
      $('#pedidoForm').submit(function(event) {
          event.preventDefault();

          const form = $(this);
          const formData = new FormData(form[0]);
          formData.append('items', JSON.stringify(itemsArray));

          fetch(form.attr('action'), {
              method: form.attr('method'),
              body: formData,
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
              }
          }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  Swal.fire({
                      title: 'Â¡Registro exitoso!',
                      text: 'El pedido se ha registrado correctamente.',
                      icon: 'success',
                      onClose: () => {
                          location.reload();
                      }
                  });
              } else {
                  Swal.fire('Error', 'Hubo un problema al registrar el pedido.', 'error');
              }
          });
      });
  });
</script>
