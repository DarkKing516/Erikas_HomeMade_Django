{% extends 'layouts/navbar.html' %}
{% load humanize %}
{% load i18n %}
{% load custom_filters %}
{% load static %}

{% block content %}
<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Estilo para el selector de año */
    .year-selector {
        padding: 8px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
        cursor: pointer;
        transition: border-color 0.3s, background-color 0.3s;
    }

    .year-selector:focus {
        border-color: #0056b3;
        background-color: #e9ecef;
        outline: none;
    }

    /* Estilo para el botón de aplicar */
    .submit-button {
        padding: 8px 16px;
        font-size: 16px;
        color: #fff;
        background-color: #007bff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s, box-shadow 0.3s;
        margin-bottom: 40px; /* Ajusta el espacio según sea necesario */
    }

    .submit-button:hover {
        background-color: #0056b3;
    }

    .submit-button:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(38, 143, 255, 0.5);
    }
</style>

<!-- Formulario para seleccionar el año -->
<form method="get" action="{% url 'home:dashboard' %}">
    <label for="year">Selecciona el año:</label>
    <select name="year" id="year" class="year-selector">
        <option value="" {% if not selected_year %}selected{% endif %}>Selecciona el año</option>
        {% for year in years %}
            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
    </select>
    <button type="submit" class="submit-button">Aplicar</button>
</form>
<!-- Contenedor de las gráficas -->
<div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 20px;">
    <!-- Gráficas de la primera fila -->
    <div style="flex: 1; max-width: 600px;">
        <h3>Total de Ventas</h3>
        <canvas id="ventasChart" style="max-width: 100%; max-height: 400px;"></canvas>
    </div>
    <div style="flex: 1; max-width: 600px;">
        <h3>Productos más Vendidos</h3>
        <canvas id="productosChart" style="max-width: 100%; max-height: 400px;"></canvas>
    </div>
</div>

<!-- Gráfica de la segunda fila -->
<div style="display: flex; justify-content: center; margin-top: 20px;">
    <div style="max-width: 600px; width: 100%;">
        <h3>Pedidos por Estado</h3>
        <canvas id="pedidosChart" style="max-width: 100%; max-height: 400px;"></canvas>
    </div>
</div>

<script>
    // Convertir las variables de Django en objetos JSON válidos en JavaScript
    var ventasFechas = JSON.parse('{{ ventas_fechas_json|escapejs }}');
    var ventasTotales = JSON.parse('{{ ventas_totales_json|escapejs }}');
    var productosNombres = JSON.parse('{{ productos_nombres_json|escapejs }}');
    var productosTotales = JSON.parse('{{ productos_totales_json|escapejs }}');
    var pedidosEstados = JSON.parse('{{ pedidos_estados_json|escapejs }}');
    var pedidosTotales = JSON.parse('{{ pedidos_totales_json|escapejs }}');

    // Inicializar los gráficos
    function initializeChart(ctx, type, labels, data, label, backgroundColor, borderColor) {
        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                if (Number.isInteger(value)) {
                                    return value;
                                }
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });
    }

    // Gráfico de Ventas en el Rango de Fechas (Barras Verticales)
    var ctx1 = document.getElementById('ventasChart').getContext('2d');
    initializeChart(
        ctx1,
        'bar',
        ventasFechas,
        ventasTotales.length ? ventasTotales : [0], // Mostrar 0 si no hay datos
        'Total de Ventas',
        'rgba(75, 192, 192, 0.6)',
        'rgba(75, 192, 192, 1)'
    );

    // Gráfico de Productos más Vendidos
    var ctx2 = document.getElementById('productosChart').getContext('2d');
    initializeChart(
        ctx2,
        'bar',
        productosNombres,
        productosTotales.length ? productosTotales : [0], // Mostrar 0 si no hay datos
        'Cantidad Vendida',
        'rgba(153, 102, 255, 0.6)'
    );

    // Gráfico de Pedidos por Estado
    var ctx3 = document.getElementById('pedidosChart').getContext('2d');
    new Chart(ctx3, {
        type: 'pie',
        data: {
            labels: pedidosEstados,
            datasets: [{
                label: 'Pedidos',
                data: pedidosTotales.length ? pedidosTotales : [0], // Mostrar 0 si no hay datos
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)'
                ]
            }]
        },
        options: {
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            const dataset = tooltipItem.dataset;
                            const total = dataset.data.reduce((acc, curr) => acc + curr, 0);
                            const currentValue = dataset.data[tooltipItem.dataIndex];
                            const percentage = ((currentValue / total) * 100).toFixed(2);

                            return `${tooltipItem.label}: ${currentValue} (${percentage}%)`;
                        }
                    }
                },
                legend: {
                    display: true
                }
            }
        }
    });
</script>

{% endblock %}
