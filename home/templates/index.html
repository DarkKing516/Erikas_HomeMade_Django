{% extends 'layouts/index.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">

<!-- Hero Principal -->
{% include 'includes/hero-index.html' %}

<!--
// v0 by Vercel.
// https://v0.dev/t/xDrF7U2dpDT
-->
<!-- Hero Servicios -->
{% include 'includes/hero-servicios.html' %}

<!-- ista previa productos -->
{% include 'includes/products-preview.html' %}

<!-- Section Services  Last section-->
{% include 'includes/services-carrousel.html' %}

<!-- Relizar Reserva -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<section class="section section-sm section-first bg-default" id="CrearReserva">
  <div class="container">
    <center>
      <h3 class="heading-3">RESERVAS</h3>
    </center>
    <form class="rd-form rd-mailform form-style-1" data-form-output="form-output-global" data-form-type="contact"
      action="" onsubmit="validateForm(event)" method="post" id="myForm" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row row-20 gutters-20">
        <div class="col-md-6 col-lg-4 oh-desktop">
          <div class="form-wrap wow slideInDown">
            <input type="number" name="usuario" id="" hidden value="{{ request.session.usuario_id }}">
            <input type="text" id="" readonly value="{{ request.session.nombre_usuario }}" class="form-input">
          </div>
        </div>
        <div class="col-md-6 col-lg-4 oh-desktop">
          <div class="form-wrap wow slideInUp">
            {{ form.fecha_cita }}
            <label class="form-label" for="contact-email-6"></label>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 oh-desktop">
          <div class="form-wrap wow slideInUp"> 
            <select id="servicios" class="form-input" name="servicio">
              {% for servicio in servicios %}
                <option value="{{ servicio.idServicio }}">{{ servicio.nombre_servicio }}</option>
              {% endfor %}
            </select> 
          </div>
        </div>
        <div class="col-12">
          <div class="form-wrap wow fadeIn">
            {{ form.descripcion }}
        </div>

      </div>
      <div class="group-custom-1 group-middle oh-desktop">
        {% if not request.session.usuario_id %}
        <button class="button button-lg button-primary button-winona wow fadeInRight" onclick="window.location.href = '{% url 'usuarios:login' %}';" style="text-transform: capitalize;">Primero inicia sesión!</button>
        {% else %}
        <button class="button button-lg button-primary button-winona wow fadeInRight" type="submit">Realizar reserva</button>
        {% endif %}
        <article class="quote-classic quote-classic-3 wow slideInDown">
          <div class="quote-classic-text">
            <p class="q">Por favor realizar la reserva dos días después de la fecha actual hasta dos semanas después de la misma.</p>
          </div>
        </article>
      </div>
    </form>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Extrae los parámetros de la URL
    const params = new URLSearchParams(window.location.search);
    const servicioEnviado = params.get('servicioEnviado');
  
    // Si existe el parámetro, rellena el campo de descripción
    if (servicioEnviado) {
      const descripcionField = document.getElementById('id_descripcion');
      if (descripcionField) {
        descripcionField.value = servicioEnviado;
      }
    }
  });
  </script>
  
<!-- Incluye Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Incluye SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="{% static 'js/core.min.js' %}"></script>
<script src="{% static 'js/script.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>

  document.addEventListener('DOMContentLoaded', function() {
      fetch("{% url 'pedidos:listar_servicios' %}")
          .then(response => response.json())
          .then(data => {
              const selectElement = document.getElementById('servicios');
              data.forEach(servicio => {
                  const option = document.createElement('option');
                  option.value = servicio.id;
                  option.text = servicio.nombre;
                  selectElement.appendChild(option);
              });
          })
          .catch(error => console.error('Error al cargar los servicios:', error));
  
      // Añadir el servicio seleccionado a la descripción
      document.getElementById('servicios').addEventListener('change', function() {
          var selectedServiceText = this.options[this.selectedIndex].text;
          var descripcionField = document.getElementById('id_descripcion');
          var currentDescription = descripcionField.value;
  
          if (currentDescription) {
              currentDescription += ', ' + selectedServiceText;
          } else {
              currentDescription = selectedServiceText;
          }
  
          descripcionField.value = currentDescription;
      });
  });

  $(document).ready(function() {
    $('#servicios').select2();

    // Añadir el servicio seleccionado a la descripción
    $('#servicios').on('change', function() {
      var selectedServiceText = $(this).find('option:selected').text();
      var descripcionField = $('#id_descripcion');
      var currentDescription = descripcionField.val();

      if (currentDescription) {
        currentDescription += ', ' + selectedServiceText;
      } else {
        currentDescription = selectedServiceText;
      }

      descripcionField.val(currentDescription);
    });
  });

   document.addEventListener('DOMContentLoaded', function() {
    flatpickr("#id_fecha_cita", {
      enableTime: true,
      dateFormat: 'Y-m-d H:i',
      minDate: "today",
      minTime: "08:00",
      maxTime: "17:00",
      time_24hr: true,
      minuteIncrement: 30,
    });
  });

  function validateForm() {
    event.preventDefault();

    const form = document.getElementById('myForm');
    const fechaCitaInput = form.querySelector('input[name="fecha_cita"]');
    const fechaCita = new Date(fechaCitaInput.value);

    if (isNaN(fechaCita.getTime())) {
      Swal.fire({
        title: 'Error',
        text: 'Fecha y hora no válidas. Por favor, ingrese una fecha y hora correctas.',
        icon: 'error'
      });
      return;
    }

    const horaInicio = 8; // 8:00 AM
    const horaFin = 17; // 5:00 PM
    const horaReserva = fechaCita.getHours();
    const minutoReserva = fechaCita.getMinutes();

    if (horaReserva < horaInicio || horaReserva >= horaFin || (minutoReserva !== 0 && minutoReserva !== 30)) {
      Swal.fire({
        title: 'Error',
        text: 'La hora debe estar entre las 8:00 AM y las 5:00 PM, y debe ser en intervalos de media hora (por ejemplo, 8:00, 8:30).',
        icon: 'error'
      });
      return;
    }

    const formData = new FormData(form);

    fetch("{% url 'reservas:crear_reserva' %}", {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        Swal.fire({
          title: '¡Registro exitoso!',
          text: 'La reserva se ha registrado correctamente.',
          icon: 'success',
          onClose: () => {
            window.location.href = "{% url 'reservas:listar_reserva_cliente' %}";
          }
        }).then(() => {
          window.location.href = "{% url 'reservas:listar_reserva_cliente' %}";
        });
      } else if (data.message) {
        Swal.fire({
          title: 'Error',
          text: data.message,
          icon: 'error',
        });
      } else if (data.errors) {
        let errorMessage = "Hubo un error al procesar su solicitud:<br>";
        for (const key in data.errors) {
          errorMessage += `${data.errors[key]}<br>`;
        }
        Swal.fire({
          title: 'Error',
          html: errorMessage,
          icon: 'error',
        });
      } else {
        Swal.fire({
          title: 'Error',
          text: 'Hubo un error al procesar su solicitud. Por favor, revise los campos e inténtelo de nuevo.',
          icon: 'error'
        });
      }
    })
    .catch(errors => {
      Swal.fire({
        title: 'Error',
        text: 'Hubo un error al procesar su solicitud. Por favor, inténtelo de nuevo más tarde.',
        icon: 'error'
      });
      console.error('Error:', errors);
    });
  }
</script>
{% endblock %}